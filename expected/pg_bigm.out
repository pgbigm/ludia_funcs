\pset null '(null)'
-- Load pg_bigm and ludia_funcs
CREATE EXTENSION pg_bigm;
CREATE EXTENSION ludia_funcs;
-- Set parameters for the tests
SET standard_conforming_strings TO off;
SET escape_string_warning TO off;
SET work_mem = '4MB';
SET enable_seqscan TO off;
SET enable_bitmapscan TO on;
-- Test the case where the columns with CHAR data type were indexed
-- with pg_bigm and pgs2norm function.
CREATE TABLE char_tbl (col1 char(256), col2 char(256), col3 char(256));
\copy char_tbl from data/test_tbl.txt
CREATE INDEX char_tbl_idx ON char_tbl USING gin (pgs2norm(col1) gin_bigm_ops,
                                                                   pgs2norm(col2) gin_bigm_ops,
                                                                   pgs2norm(col3) gin_bigm_ops)
                                                                   WITH (FASTUPDATE = off);
SELECT pgs2snippet1(1, 32, 1, '★', '★', 0, 'v(株)', col1) FROM char_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('v(株)'))
    ORDER BY col1;
     pgs2snippet1      
-----------------------
 ロﾊAbＣｄ1２③★Ⅳ㈱★');
(1 row)

SELECT pgs2snippet1(1, 32, 1, '★', '★', 0, '②⓪', col1) FROM char_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('②⓪'))
    ORDER BY col1;
 pgs2snippet1  
---------------
 ★ 20★13.04.05
(1 row)

SELECT pgs2snippet1(1, 32, 1, '★', '★', 0, 'ｱﾌﾟﾘｹｰｼｮﾝ', col1) FROM char_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('ｱﾌﾟﾘｹｰｼｮﾝ'))
    ORDER BY col1;
      pgs2snippet1      
------------------------
 ト★アプリケーション★側
(1 row)

-- Test the case where the columns with VARCHAR data type were indexed
-- with pg_bigm and pgs2norm function.
CREATE TABLE varchar_tbl (col1 varchar(256), col2 varchar(256), col3 varchar(256));
\copy varchar_tbl from data/test_tbl.txt
CREATE INDEX varchar_tbl_idx ON varchar_tbl USING gin (pgs2norm(col1) gin_bigm_ops,
                                                                           pgs2norm(col2) gin_bigm_ops,
                                                                           pgs2norm(col3) gin_bigm_ops)
                                                                           WITH (FASTUPDATE = off);
SELECT pgs2snippet1(1, 32, 1, '★', '★', 0, 'v(株)', col1) FROM varchar_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('v(株)'))
    ORDER BY col1;
     pgs2snippet1      
-----------------------
 ロﾊAbＣｄ1２③★Ⅳ㈱★');
(1 row)

SELECT pgs2snippet1(1, 32, 1, '★', '★', 0, '②⓪', col1) FROM varchar_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('②⓪'))
    ORDER BY col1;
 pgs2snippet1  
---------------
 ★ 20★13.04.05
(1 row)

SELECT pgs2snippet1(1, 32, 1, '★', '★', 0, 'ｱﾌﾟﾘｹｰｼｮﾝ', col1) FROM varchar_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('ｱﾌﾟﾘｹｰｼｮﾝ'))
    ORDER BY col1;
      pgs2snippet1      
------------------------
 ト★アプリケーション★側
(1 row)

-- Test the case where the columns with TEXT data type were indexed
-- with pg_bigm and pgs2norm function.
CREATE TABLE text_tbl (col1 text, col2 text, col3 text);
\copy text_tbl from data/test_tbl.txt
CREATE INDEX text_tbl_idx ON text_tbl USING gin (pgs2norm(col1) gin_bigm_ops,
                                                                  pgs2norm(col2) gin_bigm_ops,
                                                                  pgs2norm(col3) gin_bigm_ops)
                                                                  WITH (FASTUPDATE = off);
SELECT pgs2snippet1(1, 32, 1, '★', '★', 0, 'v(株)', col1) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('v(株)'))
    ORDER BY col1;
     pgs2snippet1      
-----------------------
 ロﾊAbＣｄ1２③★Ⅳ㈱★');
(1 row)

SELECT pgs2snippet1(1, 32, 1, '★', '★', 0, '②⓪', col1) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('②⓪'))
    ORDER BY col1;
 pgs2snippet1  
---------------
 ★ 20★13.04.05
(1 row)

SELECT pgs2snippet1(1, 32, 1, '★', '★', 0, 'ｱﾌﾟﾘｹｰｼｮﾝ', col1) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('ｱﾌﾟﾘｹｰｼｮﾝ'))
    ORDER BY col1;
      pgs2snippet1      
------------------------
 ト★アプリケーション★側
(1 row)

-- Test the case where condition has "AND".
SELECT count(*) FROM text_tbl WHERE
    pgs2norm(col1) LIKE likequery(pgs2norm('解釈')) AND
    pgs2norm(col1) LIKE likequery(pgs2norm('実装')) AND
    pgs2norm(col1) LIKE likequery(pgs2norm('場合'));
 count 
-------
     1
(1 row)

EXPLAIN (costs off) SELECT count(*) FROM text_tbl WHERE
    pgs2norm(col1) LIKE likequery(pgs2norm('解釈')) AND
    pgs2norm(col1) LIKE likequery(pgs2norm('実装')) AND
    pgs2norm(col1) LIKE likequery(pgs2norm('場合'));
                                                                  QUERY PLAN                                                                  
----------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: ((pgs2norm(col1) ~~ '%解釈%'::text) AND (pgs2norm(col1) ~~ '%実装%'::text) AND (pgs2norm(col1) ~~ '%場合%'::text))
         ->  Bitmap Index Scan on text_tbl_idx
               Index Cond: ((pgs2norm(col1) ~~ '%解釈%'::text) AND (pgs2norm(col1) ~~ '%実装%'::text) AND (pgs2norm(col1) ~~ '%場合%'::text))
(5 rows)

SELECT count(*) FROM text_tbl WHERE
    pgs2norm(col1) LIKE likequery(pgs2norm('解釈')) AND
    pgs2norm(col2) LIKE likequery(pgs2norm('ﾕｰｻ゛')) AND
    pgs2norm(col3) LIKE likequery(pgs2norm('ＳｑＬ'));
 count 
-------
     1
(1 row)

EXPLAIN (costs off) SELECT count(*) FROM text_tbl WHERE
    pgs2norm(col1) LIKE likequery(pgs2norm('解釈')) AND
    pgs2norm(col2) LIKE likequery(pgs2norm('ﾕｰｻ゛')) AND
    pgs2norm(col3) LIKE likequery(pgs2norm('ＳｑＬ'));
                                                                  QUERY PLAN                                                                   
-----------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: ((pgs2norm(col1) ~~ '%解釈%'::text) AND (pgs2norm(col2) ~~ '%ユーザ%'::text) AND (pgs2norm(col3) ~~ '%sql%'::text))
         ->  Bitmap Index Scan on text_tbl_idx
               Index Cond: ((pgs2norm(col1) ~~ '%解釈%'::text) AND (pgs2norm(col2) ~~ '%ユーザ%'::text) AND (pgs2norm(col3) ~~ '%sql%'::text))
(5 rows)

-- Test the case where condition has "OR".
SELECT count(*) FROM text_tbl WHERE
    pgs2norm(col2) LIKE likequery(pgs2norm('ﾊ゜ラメータ')) OR
    pgs2norm(col2) LIKE likequery(pgs2norm('㉜')) OR
    pgs2norm(col2) LIKE likequery(pgs2norm('  '));
 count 
-------
     9
(1 row)

EXPLAIN (costs off) SELECT count(*) FROM text_tbl WHERE
    pgs2norm(col2) LIKE likequery(pgs2norm('ﾊ゜ラメータ')) OR
    pgs2norm(col2) LIKE likequery(pgs2norm('㉜')) OR
    pgs2norm(col2) LIKE likequery(pgs2norm('  '));
                                                                QUERY PLAN                                                                
------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: ((pgs2norm(col2) ~~ '%パラメータ%'::text) OR (pgs2norm(col2) ~~ '%32%'::text) OR (pgs2norm(col2) ~~ '%  %'::text))
         ->  BitmapOr
               ->  Bitmap Index Scan on text_tbl_idx
                     Index Cond: (pgs2norm(col2) ~~ '%パラメータ%'::text)
               ->  Bitmap Index Scan on text_tbl_idx
                     Index Cond: (pgs2norm(col2) ~~ '%32%'::text)
               ->  Bitmap Index Scan on text_tbl_idx
                     Index Cond: (pgs2norm(col2) ~~ '%  %'::text)
(10 rows)

SELECT count(*) FROM text_tbl WHERE
    pgs2norm(col1) LIKE likequery(pgs2norm('ﾊ゜ラメータ')) OR
    pgs2norm(col2) LIKE likequery(pgs2norm('㉜')) OR
    pgs2norm(col3) LIKE likequery(pgs2norm('  '));
 count 
-------
    10
(1 row)

EXPLAIN (costs off) SELECT count(*) FROM text_tbl WHERE
    pgs2norm(col1) LIKE likequery(pgs2norm('ﾊ゜ラメータ')) OR
    pgs2norm(col2) LIKE likequery(pgs2norm('㉜')) OR
    pgs2norm(col3) LIKE likequery(pgs2norm('  '));
                                                                QUERY PLAN                                                                
------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: ((pgs2norm(col1) ~~ '%パラメータ%'::text) OR (pgs2norm(col2) ~~ '%32%'::text) OR (pgs2norm(col3) ~~ '%  %'::text))
         ->  BitmapOr
               ->  Bitmap Index Scan on text_tbl_idx
                     Index Cond: (pgs2norm(col1) ~~ '%パラメータ%'::text)
               ->  Bitmap Index Scan on text_tbl_idx
                     Index Cond: (pgs2norm(col2) ~~ '%32%'::text)
               ->  Bitmap Index Scan on text_tbl_idx
                     Index Cond: (pgs2norm(col3) ~~ '%  %'::text)
(10 rows)

-- Test the case where condition has "NOT".
SELECT count(*) FROM text_tbl WHERE
    pgs2norm(col3) LIKE likequery(pgs2norm('ludia')) AND
    NOT pgs2norm(col3) LIKE likequery(pgs2norm('㊐')) AND
    NOT pgs2norm(col3) LIKE likequery(pgs2norm('Ⓟ'));
 count 
-------
    11
(1 row)

EXPLAIN (costs off) SELECT count(*) FROM text_tbl WHERE
    pgs2norm(col3) LIKE likequery(pgs2norm('ludia')) AND
    NOT pgs2norm(col3) LIKE likequery(pgs2norm('㊐')) AND
    NOT pgs2norm(col3) LIKE likequery(pgs2norm('Ⓟ'));
                                        QUERY PLAN                                        
------------------------------------------------------------------------------------------
 Aggregate
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: (pgs2norm(col3) ~~ '%ludia%'::text)
         Filter: ((pgs2norm(col3) !~~ '%日%'::text) AND (pgs2norm(col3) !~~ '%p%'::text))
         ->  Bitmap Index Scan on text_tbl_idx
               Index Cond: (pgs2norm(col3) ~~ '%ludia%'::text)
(6 rows)

SELECT count(*) FROM text_tbl WHERE
    pgs2norm(col2) LIKE likequery(pgs2norm('ludia')) AND
    NOT pgs2norm(col3) LIKE likequery(pgs2norm('㊐')) AND
    NOT pgs2norm(col1) LIKE likequery(pgs2norm('Ⓟ'));
 count 
-------
     8
(1 row)

EXPLAIN (costs off) SELECT count(*) FROM text_tbl WHERE
    pgs2norm(col2) LIKE likequery(pgs2norm('ludia')) AND
    NOT pgs2norm(col3) LIKE likequery(pgs2norm('㊐')) AND
    NOT pgs2norm(col1) LIKE likequery(pgs2norm('Ⓟ'));
                                        QUERY PLAN                                        
------------------------------------------------------------------------------------------
 Aggregate
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: (pgs2norm(col2) ~~ '%ludia%'::text)
         Filter: ((pgs2norm(col3) !~~ '%日%'::text) AND (pgs2norm(col1) !~~ '%p%'::text))
         ->  Bitmap Index Scan on text_tbl_idx
               Index Cond: (pgs2norm(col2) ~~ '%ludia%'::text)
(6 rows)

-- Test for UPDATE and DELETE
UPDATE text_tbl SET col1 = col2, col2 = col3, col3 = col1;
UPDATE text_tbl SET col1 = col2, col2 = col3, col3 = col1;
UPDATE text_tbl SET col1 = col2, col2 = col3, col3 = col1;
SELECT pgs2snippet1(1, 32, 1, '★', '★', 0, 'v(株)', col1) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('v(株)'))
    ORDER BY col1;
     pgs2snippet1      
-----------------------
 ロﾊAbＣｄ1２③★Ⅳ㈱★');
(1 row)

SELECT pgs2snippet1(1, 32, 1, '★', '★', 0, '②⓪', col1) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('②⓪'))
    ORDER BY col1;
 pgs2snippet1  
---------------
 ★ 20★13.04.05
(1 row)

SELECT pgs2snippet1(1, 32, 1, '★', '★', 0, 'ｱﾌﾟﾘｹｰｼｮﾝ', col1) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('ｱﾌﾟﾘｹｰｼｮﾝ'))
    ORDER BY col1;
      pgs2snippet1      
------------------------
 ト★アプリケーション★側
(1 row)

-- The text search for updated or deleted records must return no results
-- even when recheck is skipped on the text search.
EXPLAIN (costs off) UPDATE text_tbl SET col1 =
    (select string_agg(chr(num), '') from generate_series(ascii('㋐'), ascii('㋾')) num)
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('㊀'));
                         QUERY PLAN                         
------------------------------------------------------------
 Update on text_tbl
   InitPlan 1 (returns $0)
     ->  Aggregate
           ->  Function Scan on generate_series num
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: (pgs2norm(col1) ~~ '%一%'::text)
         ->  Bitmap Index Scan on text_tbl_idx
               Index Cond: (pgs2norm(col1) ~~ '%一%'::text)
(8 rows)

UPDATE text_tbl SET col1 =
    (select string_agg(chr(num), '') from generate_series(ascii('㋐'), ascii('㋾')) num)
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('㊀'));
SELECT count(*) FROM text_tbl WHERE pgs2norm(col1) LIKE likequery(pgs2norm('㊀'));
 count 
-------
     0
(1 row)

EXPLAIN (costs off) DELETE FROM text_tbl WHERE pgs2norm(col1) like likequery(pgs2norm('⑬'));
                         QUERY PLAN                         
------------------------------------------------------------
 Delete on text_tbl
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: (pgs2norm(col1) ~~ '%13%'::text)
         ->  Bitmap Index Scan on text_tbl_idx
               Index Cond: (pgs2norm(col1) ~~ '%13%'::text)
(5 rows)

DELETE FROM text_tbl WHERE pgs2norm(col1) like likequery(pgs2norm('⑬'));
SELECT count(*) FROM text_tbl WHERE pgs2norm(col1) like likequery(pgs2norm('⑬'));
 count 
-------
     0
(1 row)

-- Test whether both seq scan and bitmap scan return the same results
SET enable_seqscan to on;
SET enable_bitmapscan to off;
SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都山田太郎'))
    ORDER BY col1;
     replace     
-----------------
 東京都*山田太郎
 東京都山田太郎
(2 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都 山田太郎'))
    ORDER BY col1;
     replace     
-----------------
 東京都 山田太郎
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都 山田 太郎'))
    ORDER BY col1;
     replace      
------------------
 東京都 山田 太郎
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm(E'東京都\t山田太郎'))
    ORDER BY col1;
     replace     
-----------------
 東京都*山田太郎
 東京都山田太郎
(2 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都山田　太郎'))
    ORDER BY col1;
     replace      
------------------
 東京都山田 太郎
 東京都山田　太郎
(2 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('京都山'))
    ORDER BY col1;
     replace      
------------------
 東京都*山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(4 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('京都 山田'))
    ORDER BY col1;
     replace      
------------------
 東京都 山田 太郎
 東京都 山田太郎
(2 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('都 山田'))
    ORDER BY col1;
     replace      
------------------
 東京都 山田 太郎
 東京都 山田太郎
(2 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('都 山'))
    ORDER BY col1;
     replace      
------------------
 東京都 山田 太郎
 東京都 山田太郎
(2 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('  山'))
    ORDER BY col1;
     replace      
------------------
 東京都  山田太郎
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('京都  '))
    ORDER BY col1;
     replace      
------------------
 東京都  山田太郎
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm(E'都\t'))
    ORDER BY col1;
     replace      
------------------
 東京と京都
 東京都
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(9 rows)

SELECT count(*) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('　'));
 count 
-------
    48
(1 row)

SELECT count(*) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm(' '));
 count 
-------
    48
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('山'))
    ORDER BY col1;
     replace      
------------------
 山田
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(8 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm(' 山 '))
    ORDER BY col1;
 replace 
---------
(0 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('ポ'))
    ORDER BY col1;
 replace 
---------
 ポ
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('ﾎﾟ'))
    ORDER BY col1;
 replace 
---------
 ポ
(1 row)

SELECT count(*) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('A'));
 count 
-------
    30
(1 row)

SELECT count(*) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('a'));
 count 
-------
    30
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('AA'))
    ORDER BY col1;
 replace 
---------
(0 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都'))
    ORDER BY col1;
     replace      
------------------
 東京都
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(8 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都'))
    AND pgs2norm(col1) LIKE likequery(pgs2norm('山'))
    ORDER BY col1;
     replace      
------------------
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(7 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('山'))
    AND pgs2norm(col1) LIKE likequery(pgs2norm('東京都'))
    ORDER BY col1;
     replace      
------------------
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(7 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都'))
    AND pgs2norm(col1) LIKE likequery(pgs2norm('山'))
    AND pgs2norm(col1) LIKE likequery(pgs2norm('田'))
    ORDER BY col1;
     replace      
------------------
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(7 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都'))
    AND pgs2norm(col1) LIKE likequery(pgs2norm('山'))
    OR pgs2norm(col1) LIKE likequery(pgs2norm('ポ'))
    ORDER BY col1;
     replace      
------------------
 ポ
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(8 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都山田太郎'))
    ORDER BY col1;
                          QUERY PLAN                          
--------------------------------------------------------------
 Sort
   Sort Key: col1
   ->  Seq Scan on text_tbl
         Filter: (pgs2norm(col1) ~~ '%東京都山田太郎%'::text)
(4 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都 山田 太郎'))
    ORDER BY col1;
                           QUERY PLAN                           
----------------------------------------------------------------
 Sort
   Sort Key: col1
   ->  Seq Scan on text_tbl
         Filter: (pgs2norm(col1) ~~ '%東京都 山田 太郎%'::text)
(4 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm(E'東京都\t山田太郎'))
    ORDER BY col1;
                          QUERY PLAN                          
--------------------------------------------------------------
 Sort
   Sort Key: col1
   ->  Seq Scan on text_tbl
         Filter: (pgs2norm(col1) ~~ '%東京都山田太郎%'::text)
(4 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('都 山田'))
    ORDER BY col1;
                      QUERY PLAN                       
-------------------------------------------------------
 Sort
   Sort Key: col1
   ->  Seq Scan on text_tbl
         Filter: (pgs2norm(col1) ~~ '%都 山田%'::text)
(4 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('  山'))
    ORDER BY col1;
                     QUERY PLAN                     
----------------------------------------------------
 Sort
   Sort Key: col1
   ->  Seq Scan on text_tbl
         Filter: (pgs2norm(col1) ~~ '%  山%'::text)
(4 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm(E'都\t'))
    ORDER BY col1;
                    QUERY PLAN                    
--------------------------------------------------
 Sort
   Sort Key: col1
   ->  Seq Scan on text_tbl
         Filter: (pgs2norm(col1) ~~ '%都%'::text)
(4 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('　'))
    ORDER BY col1;
                   QUERY PLAN                    
-------------------------------------------------
 Sort
   Sort Key: col1
   ->  Seq Scan on text_tbl
         Filter: (pgs2norm(col1) ~~ '% %'::text)
(4 rows)

SET enable_seqscan to off;
SET enable_bitmapscan to on;
SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都山田太郎'))
    ORDER BY col1;
     replace     
-----------------
 東京都*山田太郎
 東京都山田太郎
(2 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都 山田太郎'))
    ORDER BY col1;
     replace     
-----------------
 東京都 山田太郎
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都 山田 太郎'))
    ORDER BY col1;
     replace      
------------------
 東京都 山田 太郎
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm(E'東京都\t山田太郎'))
    ORDER BY col1;
     replace     
-----------------
 東京都*山田太郎
 東京都山田太郎
(2 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都山田　太郎'))
    ORDER BY col1;
     replace      
------------------
 東京都山田 太郎
 東京都山田　太郎
(2 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('京都山'))
    ORDER BY col1;
     replace      
------------------
 東京都*山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(4 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('京都 山田'))
    ORDER BY col1;
     replace      
------------------
 東京都 山田 太郎
 東京都 山田太郎
(2 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('都 山田'))
    ORDER BY col1;
     replace      
------------------
 東京都 山田 太郎
 東京都 山田太郎
(2 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('都 山'))
    ORDER BY col1;
     replace      
------------------
 東京都 山田 太郎
 東京都 山田太郎
(2 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('  山'))
    ORDER BY col1;
     replace      
------------------
 東京都  山田太郎
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('京都  '))
    ORDER BY col1;
     replace      
------------------
 東京都  山田太郎
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm(E'都\t'))
    ORDER BY col1;
     replace      
------------------
 東京と京都
 東京都
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(9 rows)

SELECT count(*) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('　'));
 count 
-------
    48
(1 row)

SELECT count(*) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm(' '));
 count 
-------
    48
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('山'))
    ORDER BY col1;
     replace      
------------------
 山田
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(8 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm(' 山 '))
    ORDER BY col1;
 replace 
---------
(0 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('ポ'))
    ORDER BY col1;
 replace 
---------
 ポ
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('ﾎﾟ'))
    ORDER BY col1;
 replace 
---------
 ポ
(1 row)

SELECT count(*) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('A'));
 count 
-------
    30
(1 row)

SELECT count(*) FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('a'));
 count 
-------
    30
(1 row)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('AA'))
    ORDER BY col1;
 replace 
---------
(0 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都'))
    ORDER BY col1;
     replace      
------------------
 東京都
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(8 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都'))
    AND pgs2norm(col1) LIKE likequery(pgs2norm('山'))
    ORDER BY col1;
     replace      
------------------
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(7 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('山'))
    AND pgs2norm(col1) LIKE likequery(pgs2norm('東京都'))
    ORDER BY col1;
     replace      
------------------
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(7 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都'))
    AND pgs2norm(col1) LIKE likequery(pgs2norm('山'))
    AND pgs2norm(col1) LIKE likequery(pgs2norm('田'))
    ORDER BY col1;
     replace      
------------------
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(7 rows)

SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都'))
    AND pgs2norm(col1) LIKE likequery(pgs2norm('山'))
    OR pgs2norm(col1) LIKE likequery(pgs2norm('ポ'))
    ORDER BY col1;
     replace      
------------------
 ポ
 東京都*山田太郎
 東京都  山田太郎
 東京都 山田 太郎
 東京都 山田太郎
 東京都山田 太郎
 東京都山田　太郎
 東京都山田太郎
(8 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都山田太郎'))
    ORDER BY col1;
                               QUERY PLAN                               
------------------------------------------------------------------------
 Sort
   Sort Key: col1
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: (pgs2norm(col1) ~~ '%東京都山田太郎%'::text)
         ->  Bitmap Index Scan on text_tbl_idx
               Index Cond: (pgs2norm(col1) ~~ '%東京都山田太郎%'::text)
(6 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('東京都 山田 太郎'))
    ORDER BY col1;
                                QUERY PLAN                                
--------------------------------------------------------------------------
 Sort
   Sort Key: col1
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: (pgs2norm(col1) ~~ '%東京都 山田 太郎%'::text)
         ->  Bitmap Index Scan on text_tbl_idx
               Index Cond: (pgs2norm(col1) ~~ '%東京都 山田 太郎%'::text)
(6 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm(E'東京都\t山田太郎'))
    ORDER BY col1;
                               QUERY PLAN                               
------------------------------------------------------------------------
 Sort
   Sort Key: col1
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: (pgs2norm(col1) ~~ '%東京都山田太郎%'::text)
         ->  Bitmap Index Scan on text_tbl_idx
               Index Cond: (pgs2norm(col1) ~~ '%東京都山田太郎%'::text)
(6 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('都 山田'))
    ORDER BY col1;
                           QUERY PLAN                            
-----------------------------------------------------------------
 Sort
   Sort Key: col1
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: (pgs2norm(col1) ~~ '%都 山田%'::text)
         ->  Bitmap Index Scan on text_tbl_idx
               Index Cond: (pgs2norm(col1) ~~ '%都 山田%'::text)
(6 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('  山'))
    ORDER BY col1;
                          QUERY PLAN                          
--------------------------------------------------------------
 Sort
   Sort Key: col1
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: (pgs2norm(col1) ~~ '%  山%'::text)
         ->  Bitmap Index Scan on text_tbl_idx
               Index Cond: (pgs2norm(col1) ~~ '%  山%'::text)
(6 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm(E'都\t'))
    ORDER BY col1;
                         QUERY PLAN                         
------------------------------------------------------------
 Sort
   Sort Key: col1
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: (pgs2norm(col1) ~~ '%都%'::text)
         ->  Bitmap Index Scan on text_tbl_idx
               Index Cond: (pgs2norm(col1) ~~ '%都%'::text)
(6 rows)

EXPLAIN (costs off) SELECT replace(col1, E'\t', '*') FROM text_tbl
    WHERE pgs2norm(col1) LIKE likequery(pgs2norm('　'))
    ORDER BY col1;
                        QUERY PLAN                         
-----------------------------------------------------------
 Sort
   Sort Key: col1
   ->  Bitmap Heap Scan on text_tbl
         Recheck Cond: (pgs2norm(col1) ~~ '% %'::text)
         ->  Bitmap Index Scan on text_tbl_idx
               Index Cond: (pgs2norm(col1) ~~ '% %'::text)
(6 rows)

-- Test the case where a multi-column index is created on many columns
CREATE TABLE mc31_tbl (col1 text, col2 char(256), col3 varchar(256), col4 text,
    col5 char(256), col6 varchar(256), col7 text, col8 char(256),
    col9 varchar(256), col10 text, col11 char(256), col12 varchar(256),
    col13 text, col14 char(256), col15 varchar(256), col16 text,
    col17 char(256), col18 varchar(256), col19 text, col20 char(256),
    col21 varchar(256), col22 text, col23 char(256), col24 varchar(256),
    col25 text, col26 char(256), col27 varchar(256), col28 text,
    col29 char(256), col30 varchar(256), col31 text);
CREATE INDEX mc31_tbl_idx ON mc31_tbl USING gin (pgs2norm(col1) gin_bigm_ops,
    pgs2norm(col2) gin_bigm_ops, pgs2norm(col3) gin_bigm_ops,
    pgs2norm(col4) gin_bigm_ops, pgs2norm(col5) gin_bigm_ops,
    pgs2norm(col6) gin_bigm_ops, pgs2norm(col7) gin_bigm_ops,
    pgs2norm(col8) gin_bigm_ops, pgs2norm(col9) gin_bigm_ops,
    pgs2norm(col10) gin_bigm_ops, pgs2norm(col11) gin_bigm_ops,
    pgs2norm(col12) gin_bigm_ops, pgs2norm(col13) gin_bigm_ops,
    pgs2norm(col14) gin_bigm_ops, pgs2norm(col15) gin_bigm_ops,
    pgs2norm(col16) gin_bigm_ops, pgs2norm(col17) gin_bigm_ops,
    pgs2norm(col18) gin_bigm_ops, pgs2norm(col19) gin_bigm_ops,
    pgs2norm(col20) gin_bigm_ops, pgs2norm(col21) gin_bigm_ops,
    pgs2norm(col22) gin_bigm_ops, pgs2norm(col23) gin_bigm_ops,
    pgs2norm(col24) gin_bigm_ops, pgs2norm(col25) gin_bigm_ops,
    pgs2norm(col26) gin_bigm_ops, pgs2norm(col27) gin_bigm_ops,
    pgs2norm(col28) gin_bigm_ops, pgs2norm(col29) gin_bigm_ops,
    pgs2norm(col30) gin_bigm_ops, pgs2norm(col31) gin_bigm_ops)
    WITH (FASTUPDATE = off);
\copy mc31_tbl from 'data/test_tbl_31.txt'
SELECT col1 FROM mc31_tbl
    WHERE pgs2norm(col1) like likequery(pgs2norm('＿Ｓ'))
    ORDER BY col1;
                     col1                     
----------------------------------------------
 =# SHOW ludia_funcs.escape_snippet_keyword ;
(1 row)

EXPLAIN (costs off ) SELECT col1 FROM mc31_tbl
    WHERE pgs2norm(col1) like likequery(pgs2norm('＿Ｓ'))
    ORDER BY col1;
                          QUERY PLAN                          
--------------------------------------------------------------
 Sort
   Sort Key: col1
   ->  Bitmap Heap Scan on mc31_tbl
         Recheck Cond: (pgs2norm(col1) ~~ '%\\_s%'::text)
         ->  Bitmap Index Scan on mc31_tbl_idx
               Index Cond: (pgs2norm(col1) ~~ '%\\_s%'::text)
(6 rows)

SELECT col15 FROM mc31_tbl
    WHERE pgs2norm(col15) LIKE likequery(pgs2norm('ﾃ゛ィ'))
    ORDER BY col15;
                                                                    col15                                                                     
----------------------------------------------------------------------------------------------------------------------------------------------
 •--prefix : インストール先ディレクトリを指定します。未指定時のインストール先は/usr/local/pgsqlです。このオプション指定は必須ではありません。
(1 row)

EXPLAIN (costs off ) SELECT col15 FROM mc31_tbl
    WHERE pgs2norm(col15) LIKE likequery(pgs2norm('ﾃ゛ィ'))
    ORDER BY col15;
                              QUERY PLAN                               
-----------------------------------------------------------------------
 Sort
   Sort Key: col15
   ->  Bitmap Heap Scan on mc31_tbl
         Recheck Cond: (pgs2norm((col15)::text) ~~ '%ディ%'::text)
         ->  Bitmap Index Scan on mc31_tbl_idx
               Index Cond: (pgs2norm((col15)::text) ~~ '%ディ%'::text)
(6 rows)

SELECT col31 FROM mc31_tbl
    WHERE pgs2norm(col31) LIKE likequery(pgs2norm('㊔'))
    ORDER BY col31;
           col31            
----------------------------
 $ psql -d <データベース名>
(1 row)

EXPLAIN (costs off) SELECT col31 FROM mc31_tbl
    WHERE pgs2norm(col31) LIKE likequery(pgs2norm('㊔'))
    ORDER BY col31;
                         QUERY PLAN                          
-------------------------------------------------------------
 Sort
   Sort Key: col31
   ->  Bitmap Heap Scan on mc31_tbl
         Recheck Cond: (pgs2norm(col31) ~~ '%名%'::text)
         ->  Bitmap Index Scan on mc31_tbl_idx
               Index Cond: (pgs2norm(col31) ~~ '%名%'::text)
(6 rows)

-- Test the cases where various text search patterns are used.
CREATE TABLE abc_tbl (col1 text, col2 text, col3 text);
\copy abc_tbl from data/abc_data.tsv
CREATE INDEX abc_idx ON abc_tbl USING gin (pgs2norm(col1) gin_bigm_ops, pgs2norm(col2) gin_bigm_ops, pgs2norm(col3) gin_bigm_ops);
SELECT count(*) FROM abc_tbl WHERE
    ((pgs2norm(col1) LIKE likequery(pgs2norm('AAA')) AND
    pgs2norm(col1) LIKE likequery(pgs2norm('BBB'))) AND
    pgs2norm(col1) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col2) LIKE likequery(pgs2norm('AAA')) AND
    pgs2norm(col2) LIKE likequery(pgs2norm('BBB'))) AND
    pgs2norm(col2) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col3) LIKE likequery(pgs2norm('AAA')) AND
    pgs2norm(col3) LIKE likequery(pgs2norm('BBB'))) AND
    pgs2norm(col3) LIKE likequery(pgs2norm('CCC')));
 count 
-------
   169
(1 row)

SELECT count(*) FROM abc_tbl WHERE
    ((pgs2norm(col1) LIKE likequery(pgs2norm('AAA')) AND
    pgs2norm(col1) LIKE likequery(pgs2norm('BBB'))) OR
    pgs2norm(col1) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col2) LIKE likequery(pgs2norm('AAA')) AND
    pgs2norm(col2) LIKE likequery(pgs2norm('BBB'))) OR
    pgs2norm(col2) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col3) LIKE likequery(pgs2norm('AAA')) AND
    pgs2norm(col3) LIKE likequery(pgs2norm('BBB'))) OR
    pgs2norm(col3) LIKE likequery(pgs2norm('CCC')));
 count 
-------
   485
(1 row)

SELECT count(*) FROM abc_tbl WHERE
    ((pgs2norm(col1) LIKE likequery(pgs2norm('AAA')) AND
    pgs2norm(col1) LIKE likequery(pgs2norm('BBB'))) AND
    NOT pgs2norm(col1) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col2) LIKE likequery(pgs2norm('AAA')) AND
    pgs2norm(col2) LIKE likequery(pgs2norm('BBB'))) AND
    NOT pgs2norm(col2) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col3) LIKE likequery(pgs2norm('AAA')) AND
    pgs2norm(col3) LIKE likequery(pgs2norm('BBB'))) AND
    NOT pgs2norm(col3) LIKE likequery(pgs2norm('CCC')));
 count 
-------
   169
(1 row)

SELECT count(*) FROM abc_tbl WHERE
    ((pgs2norm(col1) LIKE likequery(pgs2norm('AAA')) OR
    pgs2norm(col1) LIKE likequery(pgs2norm('BBB'))) AND
    pgs2norm(col1) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col2) LIKE likequery(pgs2norm('AAA')) OR
    pgs2norm(col2) LIKE likequery(pgs2norm('BBB'))) AND
    pgs2norm(col2) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col3) LIKE likequery(pgs2norm('AAA')) OR
    pgs2norm(col3) LIKE likequery(pgs2norm('BBB'))) AND
    pgs2norm(col3) LIKE likequery(pgs2norm('CCC')));
 count 
-------
   387
(1 row)

SELECT count(*) FROM abc_tbl WHERE
    ((pgs2norm(col1) LIKE likequery(pgs2norm('AAA')) OR
    pgs2norm(col1) LIKE likequery(pgs2norm('BBB'))) OR
    pgs2norm(col1) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col2) LIKE likequery(pgs2norm('AAA')) OR
    pgs2norm(col2) LIKE likequery(pgs2norm('BBB'))) OR
    pgs2norm(col2) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col3) LIKE likequery(pgs2norm('AAA')) OR
    pgs2norm(col3) LIKE likequery(pgs2norm('BBB'))) OR
    pgs2norm(col3) LIKE likequery(pgs2norm('CCC')));
 count 
-------
   511
(1 row)

SELECT count(*) FROM abc_tbl WHERE
    ((pgs2norm(col1) LIKE likequery(pgs2norm('AAA')) OR
    pgs2norm(col1) LIKE likequery(pgs2norm('BBB'))) AND
    NOT pgs2norm(col1) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col2) LIKE likequery(pgs2norm('AAA')) OR
    pgs2norm(col2) LIKE likequery(pgs2norm('BBB'))) AND
    NOT pgs2norm(col2) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col3) LIKE likequery(pgs2norm('AAA')) OR
    pgs2norm(col3) LIKE likequery(pgs2norm('BBB'))) AND
    NOT pgs2norm(col3) LIKE likequery(pgs2norm('CCC')));
 count 
-------
   387
(1 row)

SELECT count(*) FROM abc_tbl WHERE
    ((pgs2norm(col1) LIKE likequery(pgs2norm('AAA')) AND
    NOT pgs2norm(col1) LIKE likequery(pgs2norm('BBB'))) AND
    pgs2norm(col1) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col2) LIKE likequery(pgs2norm('AAA')) AND
    NOT pgs2norm(col2) LIKE likequery(pgs2norm('BBB'))) AND
    pgs2norm(col2) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col3) LIKE likequery(pgs2norm('AAA')) AND
    NOT pgs2norm(col3) LIKE likequery(pgs2norm('BBB'))) AND
    pgs2norm(col3) LIKE likequery(pgs2norm('CCC')));
 count 
-------
   169
(1 row)

SELECT count(*) FROM abc_tbl WHERE
    ((pgs2norm(col1) LIKE likequery(pgs2norm('AAA')) AND
    NOT pgs2norm(col1) LIKE likequery(pgs2norm('BBB'))) OR
    pgs2norm(col1) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col2) LIKE likequery(pgs2norm('AAA')) AND
    NOT pgs2norm(col2) LIKE likequery(pgs2norm('BBB'))) OR
    pgs2norm(col2) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col3) LIKE likequery(pgs2norm('AAA')) AND
    NOT pgs2norm(col3) LIKE likequery(pgs2norm('BBB'))) OR
    pgs2norm(col3) LIKE likequery(pgs2norm('CCC')));
 count 
-------
   485
(1 row)

SELECT count(*) FROM abc_tbl WHERE
    ((pgs2norm(col1) LIKE likequery(pgs2norm('AAA')) AND
    NOT pgs2norm(col1) LIKE likequery(pgs2norm('BBB'))) AND
    NOT pgs2norm(col1) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col2) LIKE likequery(pgs2norm('AAA')) AND
    NOT pgs2norm(col2) LIKE likequery(pgs2norm('BBB'))) AND
    NOT pgs2norm(col2) LIKE likequery(pgs2norm('CCC'))) OR
    ((pgs2norm(col3) LIKE likequery(pgs2norm('AAA')) AND
    NOT pgs2norm(col3) LIKE likequery(pgs2norm('BBB'))) AND
    NOT pgs2norm(col3) LIKE likequery(pgs2norm('CCC')));
 count 
-------
   169
(1 row)

